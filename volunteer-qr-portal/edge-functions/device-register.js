import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createAdminClient, corsHeaders, logAudit } from '../_shared/utils.js'

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const supabase = createAdminClient(req)
    const { device_name, org } = await req.json()

    // 1. Create Device
    // API key is auto-generated by default in DB, but we can also generate here if we want to return it explicitly and clearly.
    // Schema: api_key text unique default encode(gen_random_bytes(32), 'hex')
    // So distinct insert will trigger default.
    
    const { data: device, error } = await supabase
        .from('devices')
        .insert({ device_name, org })
        .select('*')
        .single()

    if (error) throw error

    // 2. Audit
    await logAudit(supabase, {
        actor: 'admin',
        actor_id: 'system',
        action: 'register_device',
        target_type: 'device',
        target_id: device.id,
        payload: { device_name, org }
    })

    // Return the API Key so the admin can write it down/configure the kiosk
    return new Response(JSON.stringify({ success: true, data: { ...device } }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    })

  } catch (error) {
    return new Response(JSON.stringify({ success: false, error: error.message }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 400
    })
  }
})
