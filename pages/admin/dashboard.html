<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Hackathon Nova 2026</title>
    <link rel="icon" href="/assets/logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .code-digit {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            transition: all 0.3s ease;
        }

        .code-digit:focus {
            outline: none;
            border-color: #ea580c;
            background-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.2);
            transform: scale(1.05);
        }

        .code-digit.filled {
            border-color: #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .code-digit.error {
            border-color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        #code-modal {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body class="bg-[#0e172b] text-white min-h-screen">
    <nav class="bg-black/80 backdrop-blur-lg border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <img src="../../assets/logo.png" alt="Logo" class="w-8 h-8 rounded-lg">
                    <div class="font-bold text-xl text-orange-500">Admin Dashboard</div>
                </div>
                <button id="logout-btn" class="text-gray-300 hover:text-white transition">
                    <i class="fas fa-sign-out-alt mr-2"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Code Entry Modal -->
    <div id="code-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/90 backdrop-blur-md transition-opacity" onclick="closeCodeModal()"></div>

        <!-- Modal Content -->
        <div class="relative bg-[#0f172a] border border-gray-700 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all">
            <button onclick="closeCodeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="text-center mb-8">
                <div class="bg-orange-500/10 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4 border border-orange-500/30">
                    <i class="fas fa-lock text-orange-500 text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Security Access</h2>
                <p class="text-gray-400">Enter the access code to open Settings</p>
            </div>

            <div class="mb-6">
                <div class="flex justify-center gap-3" id="code-inputs">
                    <input type="text" maxlength="1" class="code-digit" data-index="0" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="1" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="2" inputmode="numeric" pattern="[0-9]">
                    <input type="text" maxlength="1" class="code-digit" data-index="3" inputmode="numeric" pattern="[0-9]">
                </div>
                <div id="code-error" class="text-red-500 text-sm text-center mt-4 hidden">
                    <i class="fas fa-exclamation-circle mr-2"></i>Incorrect code. Please try again.
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeCodeModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                    Cancel
                </button>
                <button onclick="verifyCode()" id="verify-btn" class="flex-1 bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-3 rounded-lg font-bold hover:shadow-lg hover:shadow-orange-500/30 transition">
                    <i class="fas fa-check mr-2"></i>Verify
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-gray-700">
            <div class="flex space-x-8">
                <button id="tab-announcements" class="tab-button active py-4 px-2 border-b-2 border-orange-500 text-orange-500 font-semibold transition">
                    <i class="fas fa-bullhorn mr-2"></i>Announcements
                </button>
                <button id="tab-activity" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-white transition">
                    <i class="fas fa-history mr-2"></i>Recent Activity
                </button>
                <button id="tab-sponsors" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-white transition">
                    <i class="fas fa-handshake mr-2"></i>Sponsors
                </button>
                <button id="tab-settings" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-400 hover:text-white transition">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
            </div>
        </div>

        <!-- Announcements Tab Content -->
        <div id="announcements-tab" class="tab-content">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Manage Announcements</h1>
                <a href="announcement-form.html"
                    class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-2 rounded-lg font-bold hover:opacity-90 transition">
                    <i class="fas fa-plus mr-2"></i> New Announcement
                </a>
            </div>

            <div id="loading" class="text-center py-10 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading announcements...</p>
            </div>

            <div id="announcement-list" class="grid gap-6 hidden">
                <!-- Announcements will be injected here -->
            </div>

            <div id="empty-state" class="text-center py-20 hidden">
                <div class="bg-white/5 inline-block p-6 rounded-full mb-4">
                    <i class="fas fa-bullhorn text-4xl text-gray-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">No Announcements Yet</h3>
                <p class="text-gray-400 mb-6">Create your first announcement to keep participants updated.</p>
                <a href="announcement-form.html" class="text-orange-500 hover:text-orange-400 font-semibold">
                    Create Announcement &rarr;
                </a>
            </div>
        </div>

        <!-- Recent Activity Tab Content -->
        <div id="activity-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Recent Activity</h1>
                <button id="refresh-activity" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold transition">
                    <i class="fas fa-sync-alt mr-2"></i> Refresh
                </button>
            </div>

            <div id="activity-loading" class="text-center py-10 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading activity...</p>
            </div>

            <div id="activity-list" class="space-y-4 hidden">
                <!-- Activities will be injected here -->
            </div>

            <div id="activity-empty-state" class="text-center py-20 hidden">
                <div class="bg-white/5 inline-block p-6 rounded-full mb-4">
                    <i class="fas fa-history text-4xl text-gray-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">No Activity Yet</h3>
                <p class="text-gray-400">Activity will appear here as you manage announcements.</p>
            </div>
        </div>

        <!-- Sponsors Tab Content -->
        <div id="sponsors-tab" class="tab-content hidden">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold">Manage Sponsors</h1>
                <a href="sponsor-form.html"
                    class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-6 py-2 rounded-lg font-bold hover:opacity-90 transition">
                    <i class="fas fa-plus mr-2"></i> New Sponsor
                </a>
            </div>

            <!-- Filter by Category -->
            <div class="mb-6 flex gap-3 flex-wrap">
                <button onclick="filterSponsors('all')" class="filter-btn active px-4 py-2 rounded-lg bg-orange-500/20 text-orange-400 border border-orange-500/30 transition">
                    All
                </button>
                <button onclick="filterSponsors('title')" class="filter-btn px-4 py-2 rounded-lg bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition">
                    Title
                </button>
                <button onclick="filterSponsors('gold')" class="filter-btn px-4 py-2 rounded-lg bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition">
                    Gold
                </button>
                <button onclick="filterSponsors('silver')" class="filter-btn px-4 py-2 rounded-lg bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition">
                    Silver
                </button>
                <button onclick="filterSponsors('community')" class="filter-btn px-4 py-2 rounded-lg bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition">
                    Community
                </button>
                <button onclick="filterSponsors('tech')" class="filter-btn px-4 py-2 rounded-lg bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition">
                    Tech
                </button>
                <button onclick="filterSponsors('media')" class="filter-btn px-4 py-2 rounded-lg bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 transition">
                    Media
                </button>
            </div>

            <div id="sponsors-loading" class="text-center py-10 text-gray-400">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading sponsors...</p>
            </div>

            <div id="sponsors-list" class="grid gap-6 hidden">
                <!-- Sponsors will be injected here -->
            </div>

            <div id="sponsors-empty-state" class="text-center py-20 hidden">
                <div class="bg-white/5 inline-block p-6 rounded-full mb-4">
                    <i class="fas fa-handshake text-4xl text-gray-500"></i>
                </div>
                <h3 class="text-xl font-bold text-white mb-2">No Sponsors Yet</h3>
                <p class="text-gray-400 mb-6">Add your first sponsor to showcase on the website.</p>
                <a href="sponsor-form.html" class="text-orange-500 hover:text-orange-400 font-semibold">
                    Add Sponsor &rarr;
                </a>
            </div>
        </div>

        <!-- Settings Tab Content -->
        <div id="settings-tab" class="tab-content hidden">
            <div class="mb-8">
                <h1 class="text-3xl font-bold">Settings</h1>
                <p class="text-gray-400 mt-2">Manage your account settings</p>
            </div>

            <!-- Change Password Section -->
            <div class="bg-white/5 border border-white/10 rounded-xl p-8 backdrop-blur-sm mb-6">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-key mr-3 text-orange-500"></i>Change Password
                </h2>
                
                <form id="change-password-form" class="space-y-6">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-300 mb-2">Current Password</label>
                        <div class="relative">
                            <input type="password" id="current-password" required
                                class="w-full bg-white/10 border border-white/10 rounded-lg px-4 py-3 pr-12 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 transition"
                                placeholder="Enter your current password">
                            <button type="button" onclick="togglePasswordVisibility('current-password', 'toggle-current-password')"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition"
                                id="toggle-current-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-300 mb-2">New Password</label>
                        <div class="relative">
                            <input type="password" id="new-password" required minlength="6"
                                class="w-full bg-white/10 border border-white/10 rounded-lg px-4 py-3 pr-12 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 transition"
                                placeholder="Enter your new password (min. 6 characters)">
                            <button type="button" onclick="togglePasswordVisibility('new-password', 'toggle-new-password')"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition"
                                id="toggle-new-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Password must be at least 6 characters long</p>
                    </div>

                    <div>
                        <label for="confirm-password" class="block text-sm font-medium text-gray-300 mb-2">Confirm New Password</label>
                        <div class="relative">
                            <input type="password" id="confirm-password" required minlength="6"
                                class="w-full bg-white/10 border border-white/10 rounded-lg px-4 py-3 pr-12 text-white focus:outline-none focus:ring-2 focus:ring-orange-500 transition"
                                placeholder="Confirm your new password">
                            <button type="button" onclick="togglePasswordVisibility('confirm-password', 'toggle-confirm-password')"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition"
                                id="toggle-confirm-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>

                    <div id="password-error" class="text-red-500 text-sm hidden"></div>
                    <div id="password-success" class="text-green-500 text-sm hidden"></div>

                    <div class="flex justify-end">
                        <button type="submit" id="change-password-btn"
                            class="bg-gradient-to-r from-orange-500 to-red-600 text-white px-8 py-2 rounded-lg font-bold hover:shadow-lg hover:shadow-orange-500/30 transition">
                            <i class="fas fa-save mr-2"></i>Change Password
                        </button>
                    </div>
                </form>
            </div>

            <!-- Account Info Section -->
            <div class="bg-white/5 border border-white/10 rounded-xl p-8 backdrop-blur-sm">
                <h2 class="text-xl font-bold mb-6 flex items-center">
                    <i class="fas fa-user-circle mr-3 text-orange-500"></i>Account Information
                </h2>
                <div id="account-info" class="space-y-4">
                    <div class="flex items-center justify-between py-3 border-b border-gray-700">
                        <span class="text-gray-400">Email:</span>
                        <span class="text-white font-semibold" id="user-email">Loading...</span>
                    </div>
                    <div class="flex items-center justify-between py-3 border-b border-gray-700">
                        <span class="text-gray-400">User ID:</span>
                        <span class="text-gray-500 text-sm font-mono" id="user-id">Loading...</span>
                    </div>
                    <div class="flex items-center justify-between py-3">
                        <span class="text-gray-400">Last Login:</span>
                        <span class="text-gray-500 text-sm" id="last-login">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../../assets/js/supabase-config.js"></script>
    <script src="../../assets/js/supabase-client.js"></script>

    <script>
        const announcementList = document.getElementById('announcement-list');
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const logoutBtn = document.getElementById('logout-btn');
        const activityList = document.getElementById('activity-list');
        const activityLoading = document.getElementById('activity-loading');
        const activityEmptyState = document.getElementById('activity-empty-state');
        const refreshActivityBtn = document.getElementById('refresh-activity');

        let currentSession = null;
        const ACCESS_CODE = '1701';
        let settingsUnlocked = false;

        // Code Modal Functions
        function openCodeModal() {
            const modal = document.getElementById('code-modal');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Reset inputs
            const inputs = document.querySelectorAll('.code-digit');
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled', 'error');
            });
            
            // Focus first input
            if (inputs[0]) inputs[0].focus();
            
            // Clear error
            const errorDiv = document.getElementById('code-error');
            if (errorDiv) errorDiv.classList.add('hidden');
            
            // Reset verify button
            const verifyBtn = document.getElementById('verify-btn');
            if (verifyBtn) {
                verifyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verify';
                verifyBtn.classList.remove('bg-green-600');
            }
        }

        function closeCodeModal() {
            const modal = document.getElementById('code-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            
            // Reset inputs
            const inputs = document.querySelectorAll('.code-digit');
            inputs.forEach(input => {
                input.value = '';
                input.classList.remove('filled', 'error');
            });
        }

        function verifyCode() {
            const inputs = document.querySelectorAll('.code-digit');
            const enteredCode = Array.from(inputs).map(input => input.value).join('');
            const errorDiv = document.getElementById('code-error');
            const verifyBtn = document.getElementById('verify-btn');

            if (enteredCode === ACCESS_CODE) {
                // Correct code
                inputs.forEach(input => {
                    input.classList.remove('error');
                    input.classList.add('filled');
                });
                
                if (errorDiv) errorDiv.classList.add('hidden');
                if (verifyBtn) {
                    verifyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verified!';
                    verifyBtn.classList.add('bg-green-600');
                }
                
                // Unlock settings
                settingsUnlocked = true;
                
                // Close modal and open settings after short delay
                setTimeout(() => {
                    closeCodeModal();
                    switchTab('settings');
                }, 500);
            } else {
                // Incorrect code
                inputs.forEach(input => {
                    input.classList.remove('filled');
                    input.classList.add('error');
                });
                
                if (errorDiv) errorDiv.classList.remove('hidden');
                
                // Clear inputs after error
                setTimeout(() => {
                    inputs.forEach(input => {
                        input.value = '';
                        input.classList.remove('error');
                    });
                    if (inputs[0]) inputs[0].focus();
                }, 1000);
            }
        }

        // Code input handling - Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = document.querySelectorAll('.code-digit');
            
            inputs.forEach((input, index) => {
                // Only allow numbers
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    if (e.target.value) {
                        e.target.classList.add('filled');
                        e.target.classList.remove('error');
                        
                        // Move to next input
                        if (index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        } else {
                            // Auto-verify when last digit is entered
                            setTimeout(() => verifyCode(), 300);
                        }
                    } else {
                        e.target.classList.remove('filled');
                    }
                });

                // Handle backspace
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });

                // Handle paste
                input.addEventListener('paste', (e) => {
                    e.preventDefault();
                    const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '');
                    const digits = pastedData.split('').slice(0, 4);
                    
                    digits.forEach((digit, i) => {
                        if (inputs[i]) {
                            inputs[i].value = digit;
                            inputs[i].classList.add('filled');
                            inputs[i].classList.remove('error');
                        }
                    });
                    
                    if (digits.length === 4) {
                        setTimeout(() => verifyCode(), 300);
                    } else if (inputs[digits.length]) {
                        inputs[digits.length].focus();
                    }
                });
            });
        });

        async function checkSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
            currentSession = session;
            return session;
        }

        // Tab switching functionality
        document.getElementById('tab-announcements').addEventListener('click', () => {
            switchTab('announcements');
        });

        document.getElementById('tab-activity').addEventListener('click', () => {
            switchTab('activity');
        });

        document.getElementById('tab-sponsors').addEventListener('click', () => {
            switchTab('sponsors');
        });

        document.getElementById('tab-settings').addEventListener('click', () => {
            openCodeModal();
        });

        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-button');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.classList.remove('active', 'border-orange-500', 'text-orange-500');
                tab.classList.add('border-transparent', 'text-gray-400');
            });

            contents.forEach(content => {
                content.classList.add('hidden');
            });

            if (tabName === 'announcements') {
                document.getElementById('tab-announcements').classList.add('active', 'border-orange-500', 'text-orange-500');
                document.getElementById('tab-announcements').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('announcements-tab').classList.remove('hidden');
            } else if (tabName === 'activity') {
                document.getElementById('tab-activity').classList.add('active', 'border-orange-500', 'text-orange-500');
                document.getElementById('tab-activity').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('activity-tab').classList.remove('hidden');
                fetchActivities();
            } else if (tabName === 'sponsors') {
                document.getElementById('tab-sponsors').classList.add('active', 'border-orange-500', 'text-orange-500');
                document.getElementById('tab-sponsors').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('sponsors-tab').classList.remove('hidden');
                fetchSponsors();
            } else if (tabName === 'settings') {
                if (!settingsUnlocked) {
                    openCodeModal();
                    return;
                }
                document.getElementById('tab-settings').classList.add('active', 'border-orange-500', 'text-orange-500');
                document.getElementById('tab-settings').classList.remove('border-transparent', 'text-gray-400');
                document.getElementById('settings-tab').classList.remove('hidden');
                loadAccountInfo();
            }
        }

        // Activity logging helper function
        async function logActivity(actionType, entityType, entityId, description, metadata = {}) {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return;

                const activityData = {
                    user_id: user.id,
                    user_email: user.email,
                    action_type: actionType,
                    entity_type: entityType,
                    entity_id: entityId,
                    description: description,
                    metadata: metadata
                };

                const { error } = await supabase
                    .from('activity_log')
                    .insert([activityData]);

                if (error) {
                    console.error('Error logging activity:', error);
                }
            } catch (error) {
                console.error('Error logging activity:', error);
            }
        }

        // Fetch and display activities
        async function fetchActivities() {
            try {
                activityLoading.classList.remove('hidden');
                activityList.classList.add('hidden');
                activityEmptyState.classList.add('hidden');

                const { data, error } = await supabase
                    .from('activity_log')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                activityLoading.classList.add('hidden');

                if (!data || data.length === 0) {
                    activityEmptyState.classList.remove('hidden');
                    return;
                }

                activityList.classList.remove('hidden');
                activityList.innerHTML = '';

                data.forEach(activity => {
                    const date = new Date(activity.created_at);
                    const timeAgo = getTimeAgo(date);
                    const formattedDate = date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const actionIcons = {
                        'create': 'fa-plus-circle text-green-400',
                        'update': 'fa-edit text-blue-400',
                        'delete': 'fa-trash text-red-400',
                        'login': 'fa-sign-in-alt text-cyan-400',
                        'logout': 'fa-sign-out-alt text-gray-400'
                    };

                    const actionColors = {
                        'create': 'bg-green-500/10 border-green-500/30',
                        'update': 'bg-blue-500/10 border-blue-500/30',
                        'delete': 'bg-red-500/10 border-red-500/30',
                        'login': 'bg-cyan-500/10 border-cyan-500/30',
                        'logout': 'bg-gray-500/10 border-gray-500/30'
                    };

                    const iconClass = actionIcons[activity.action_type] || 'fa-circle text-gray-400';
                    const colorClass = actionColors[activity.action_type] || 'bg-gray-500/10 border-gray-500/30';

                    const card = document.createElement('div');
                    card.className = `bg-white/5 border border-white/10 rounded-xl p-4 hover:bg-white/10 transition ${colorClass}`;
                    card.innerHTML = `
                        <div class="flex items-start gap-4">
                            <div class="bg-white/5 rounded-full p-3 mt-1">
                                <i class="fas ${iconClass} text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-start justify-between gap-4 flex-wrap">
                                    <div class="flex-1">
                                        <p class="text-white font-semibold mb-1">${activity.description}</p>
                                        <div class="flex items-center gap-3 text-sm text-gray-400 flex-wrap">
                                            <span><i class="fas fa-user mr-1"></i>${activity.user_email || 'Unknown'}</span>
                                            <span><i class="far fa-clock mr-1"></i>${timeAgo}</span>
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        ${formattedDate}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    activityList.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching activities:', error);
                activityLoading.innerHTML = `<p class="text-red-500">Error loading activities: ${error.message}</p>`;
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        refreshActivityBtn.addEventListener('click', () => {
            fetchActivities();
        });

        // Load account information
        async function loadAccountInfo() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('user-id').textContent = user.id.substring(0, 8) + '...';
                    
                    // Try to get last login from activity log
                    const { data: activities } = await supabase
                        .from('activity_log')
                        .select('created_at')
                        .eq('user_id', user.id)
                        .eq('action_type', 'login')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (activities && activities.length > 0) {
                        const lastLogin = new Date(activities[0].created_at);
                        document.getElementById('last-login').textContent = lastLogin.toLocaleString();
                    }
                }
            } catch (error) {
                console.error('Error loading account info:', error);
            }
        }

        // Toggle password visibility function
        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Password change form handler
        const changePasswordForm = document.getElementById('change-password-form');
        const passwordError = document.getElementById('password-error');
        const passwordSuccess = document.getElementById('password-success');
        const changePasswordBtn = document.getElementById('change-password-btn');

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Hide previous messages
            passwordError.classList.add('hidden');
            passwordSuccess.classList.add('hidden');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                passwordError.textContent = 'New passwords do not match!';
                passwordError.classList.remove('hidden');
                return;
            }

            // Validate password length
            if (newPassword.length < 6) {
                passwordError.textContent = 'Password must be at least 6 characters long!';
                passwordError.classList.remove('hidden');
                return;
            }

            try {
                changePasswordBtn.disabled = true;
                changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Changing Password...';

                // First, verify current password by attempting to sign in
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }

                // Verify current password
                const { error: signInError } = await supabase.auth.signInWithPassword({
                    email: user.email,
                    password: currentPassword
                });

                if (signInError) {
                    throw new Error('Current password is incorrect');
                }

                // Update password
                const { error: updateError } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (updateError) throw updateError;

                // Log password change activity
                try {
                    await logActivity(
                        'update',
                        'account',
                        user.id,
                        'Changed password',
                        { email: user.email }
                    );
                } catch (logError) {
                    console.error('Error logging password change:', logError);
                }

                // Success
                passwordSuccess.textContent = 'Password changed successfully!';
                passwordSuccess.classList.remove('hidden');
                
                // Clear form
                changePasswordForm.reset();

                // Hide success message after 3 seconds
                setTimeout(() => {
                    passwordSuccess.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error('Error changing password:', error);
                passwordError.textContent = error.message || 'Failed to change password. Please try again.';
                passwordError.classList.remove('hidden');
            } finally {
                changePasswordBtn.disabled = false;
                changePasswordBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Change Password';
            }
        });

        async function fetchAnnouncements() {
            try {
                const { data, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                loading.classList.add('hidden');

                if (!data || data.length === 0) {
                    emptyState.classList.remove('hidden');
                    return;
                }

                announcementList.classList.remove('hidden');
                announcementList.innerHTML = '';

                data.forEach(item => {
                    const date = new Date(item.created_at).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    });

                    const typeColors = {
                        'Important': 'text-orange-400 bg-orange-500/10 border-orange-500/30',
                        'Update': 'text-blue-400 bg-blue-500/10 border-blue-500/30',
                        'Tip': 'text-green-400 bg-green-500/10 border-green-500/30',
                        'General': 'text-gray-400 bg-gray-500/10 border-gray-500/30'
                    };
                    const badgeClass = typeColors[item.type] || typeColors['General'];

                    const card = document.createElement('div');
                    card.className = 'bg-white/5 border border-white/10 rounded-xl p-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 hover:bg-white/10 transition';
                    card.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-start gap-4">
                                ${item.attachment_type === 'image' && item.attachment_url ?
                            `<img src="${item.attachment_url}" alt="Preview" class="w-24 h-24 object-cover rounded-lg border border-white/10 shrink-0">`
                            : ''}
                                <div>
                                    <div class="flex items-center gap-3 mb-2 flex-wrap">
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold border ${badgeClass}">${item.type}</span>
                                        <span class="text-gray-500 text-sm"><i class="far fa-calendar-alt mr-2"></i>${date}</span>
                                        ${!item.is_active ? '<span class="bg-red-500/10 text-red-500 px-2 py-0.5 rounded text-xs border border-red-500/20">Inactive</span>' : ''}
                                    </div>
                                    <h3 class="text-xl font-bold text-white mb-2">${item.title}</h3>
                                    <p class="text-gray-400 text-sm line-clamp-2">${item.content}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <a href="announcement-form.html?id=${item.id}" class="bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 p-3 rounded-lg transition" title="Edit">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="deleteAnnouncement('${item.id}')" class="bg-red-600/20 text-red-400 hover:bg-red-600/30 p-3 rounded-lg transition" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    announcementList.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching announcements:', error);
                loading.innerHTML = `<p class="text-red-500">Error loading announcements: \${error.message}</p>`;
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) return;

            try {
                // Fetch announcement details before deleting for logging
                const { data: announcementData } = await supabase
                    .from('announcements')
                    .select('title')
                    .eq('id', id)
                    .single();

                const { error } = await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Log activity
                await logActivity(
                    'delete',
                    'announcement',
                    id,
                    `Deleted announcement: "${announcementData?.title || 'Unknown'}"`,
                    { announcement_id: id, title: announcementData?.title }
                );

                // Refresh list
                fetchAnnouncements();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete: ' + error.message);
            }
        }

        // Sponsor Management Functions
        let currentSponsorFilter = 'all';

        function filterSponsors(category) {
            currentSponsorFilter = category;
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.classList.remove('active', 'bg-orange-500/20', 'text-orange-400', 'border-orange-500/30');
                btn.classList.add('bg-white/5', 'text-gray-300', 'border-white/10');
            });
            event.target.classList.add('active', 'bg-orange-500/20', 'text-orange-400', 'border-orange-500/30');
            event.target.classList.remove('bg-white/5', 'text-gray-300', 'border-white/10');
            fetchSponsors();
        }

        async function fetchSponsors() {
            const sponsorsList = document.getElementById('sponsors-list');
            const sponsorsLoading = document.getElementById('sponsors-loading');
            const sponsorsEmptyState = document.getElementById('sponsors-empty-state');

            try {
                sponsorsLoading.classList.remove('hidden');
                sponsorsList.classList.add('hidden');
                sponsorsEmptyState.classList.add('hidden');

                let query = supabase
                    .from('sponsors')
                    .select('*')
                    .order('display_order', { ascending: true })
                    .order('created_at', { ascending: false });

                if (currentSponsorFilter !== 'all') {
                    query = query.eq('category', currentSponsorFilter);
                }

                const { data, error } = await query;

                if (error) throw error;

                sponsorsLoading.classList.add('hidden');

                if (!data || data.length === 0) {
                    sponsorsEmptyState.classList.remove('hidden');
                    return;
                }

                sponsorsList.classList.remove('hidden');
                sponsorsList.innerHTML = '';

                const categoryLabels = {
                    'title': 'Title Sponsor',
                    'gold': 'Gold Sponsor',
                    'silver': 'Silver Sponsor',
                    'tech': 'Tech Partner',
                    'community': 'Community Partner',
                    'media': 'Media Partner'
                };

                const categoryColors = {
                    'title': 'bg-purple-500/10 border-purple-500/30 text-purple-400',
                    'gold': 'bg-yellow-500/10 border-yellow-500/30 text-yellow-400',
                    'silver': 'bg-gray-500/10 border-gray-500/30 text-gray-400',
                    'tech': 'bg-purple-500/10 border-purple-500/30 text-purple-400',
                    'community': 'bg-green-500/10 border-green-500/30 text-green-400',
                    'media': 'bg-blue-500/10 border-blue-500/30 text-blue-400'
                };

                data.forEach(sponsor => {
                    const card = document.createElement('div');
                    card.className = 'bg-white/5 border border-white/10 rounded-xl p-6 hover:bg-white/10 transition';
                    card.innerHTML = `
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-4">
                            <div class="flex-1">
                                ${sponsor.logo_url ? 
                                    `<img src="${sponsor.logo_url}" alt="${sponsor.name}" class="h-16 w-auto object-contain mb-4 md:mb-0">` :
                                    `<div class="h-16 w-32 bg-white/10 rounded flex items-center justify-center text-gray-400 text-sm mb-4 md:mb-0">No Logo</div>`
                                }
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2 flex-wrap">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold border ${categoryColors[sponsor.category] || categoryColors['silver']}">
                                        ${categoryLabels[sponsor.category] || sponsor.category}
                                    </span>
                                    ${!sponsor.is_active ? '<span class="bg-red-500/10 text-red-500 px-2 py-0.5 rounded text-xs border border-red-500/20">Inactive</span>' : ''}
                                </div>
                                <h3 class="text-xl font-bold text-white mb-1">${sponsor.name}</h3>
                                ${sponsor.website_url ? 
                                    `<a href="${sponsor.website_url}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">
                                        <i class="fas fa-external-link-alt mr-1"></i>${sponsor.website_url}
                                    </a>` : 
                                    '<p class="text-gray-500 text-sm">No website</p>'
                                }
                                <p class="text-gray-500 text-xs mt-2">Order: ${sponsor.display_order}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <a href="sponsor-form.html?id=${sponsor.id}" class="bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 p-3 rounded-lg transition" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button onclick="duplicateSponsor('${sponsor.id}')" class="bg-green-600/20 text-green-400 hover:bg-green-600/30 p-3 rounded-lg transition" title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="deleteSponsor('${sponsor.id}')" class="bg-red-600/20 text-red-400 hover:bg-red-600/30 p-3 rounded-lg transition" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    sponsorsList.appendChild(card);
                });

            } catch (error) {
                console.error('Error fetching sponsors:', error);
                sponsorsLoading.innerHTML = `<p class="text-red-500">Error loading sponsors: ${error.message}</p>`;
            }
        }

        async function duplicateSponsor(id) {
            try {
                // Fetch the sponsor data
                const { data: sponsorData, error: fetchError } = await supabase
                    .from('sponsors')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;
                if (!sponsorData) {
                    alert('Sponsor not found');
                    return;
                }

                // Get the maximum display order to set a new unique order
                const { data: maxOrderData, error: maxOrderError } = await supabase
                    .from('sponsors')
                    .select('display_order')
                    .order('display_order', { ascending: false })
                    .limit(1)
                    .single();

                // Calculate new display order: max + 1, or original + 1 if max fetch fails
                let newDisplayOrder = (sponsorData.display_order || 0) + 1;
                if (!maxOrderError && maxOrderData && maxOrderData.display_order !== null) {
                    newDisplayOrder = (maxOrderData.display_order || 0) + 1;
                }

                // Create a duplicate with modified name and new display order
                const duplicatedData = {
                    name: sponsorData.name + ' (Copy)',
                    category: sponsorData.category,
                    display_order: newDisplayOrder,
                    logo_url: sponsorData.logo_url,
                    website_url: sponsorData.website_url,
                    show_name: sponsorData.show_name || false,
                    is_active: false // Set to inactive by default for duplicated sponsors
                };

                // Insert the duplicated sponsor
                const { data: newSponsor, error: insertError } = await supabase
                    .from('sponsors')
                    .insert([duplicatedData])
                    .select()
                    .single();

                if (insertError) throw insertError;

                // Log activity
                await logActivity(
                    'create',
                    'sponsor',
                    newSponsor.id,
                    `Duplicated sponsor: "${sponsorData.name}" to "${duplicatedData.name}"`,
                    { 
                        original_sponsor_id: id,
                        new_sponsor_id: newSponsor.id,
                        name: duplicatedData.name,
                        category: duplicatedData.category
                    }
                );

                // Refresh the sponsors list
                fetchSponsors();
            } catch (error) {
                console.error('Error duplicating sponsor:', error);
                alert('Failed to duplicate sponsor: ' + error.message);
            }
        }

        async function deleteSponsor(id) {
            if (!confirm('Are you sure you want to delete this sponsor?')) return;

            try {
                const { data: sponsorData } = await supabase
                    .from('sponsors')
                    .select('name')
                    .eq('id', id)
                    .single();

                const { error } = await supabase
                    .from('sponsors')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await logActivity(
                    'delete',
                    'sponsor',
                    id,
                    `Deleted sponsor: "${sponsorData?.name || 'Unknown'}"`,
                    { sponsor_id: id, name: sponsorData?.name }
                );

                fetchSponsors();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete: ' + error.message);
            }
        }

        logoutBtn.addEventListener('click', async () => {
            // Log logout activity before signing out
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (user) {
                    await logActivity(
                        'logout',
                        'system',
                        null,
                        `Logged out from admin panel`,
                        { email: user.email }
                    );
                }
            } catch (logError) {
                console.error('Error logging logout activity:', logError);
                // Don't block logout if logging fails
            }

            await supabase.auth.signOut();
            window.location.href = 'login.html';
        });

        // Initialize
        checkSession().then(() => fetchAnnouncements());
    </script>
</body>

</html>